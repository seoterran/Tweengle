/*!
 *  opentok-whiteboard (http://github.com/aullman/opentok-whiteboard)
 *
 *  Shared Whiteboard that works with OpenTok
 *
 *  @Author: Adam Ullman (http://github.com/aullman)
 *  @Copyright (c) 2014 Adam Ullman
 *  @License: Released under the MIT license (http://opensource.org/licenses/MIT)
**/
var OpenTokWhiteboard=angular.module("opentok-whiteboard",["opentok"]).directive("otWhiteboard",["OTSession","$window",function(o,e){return{restrict:"E",template:'<canvas></canvas><div class="OT_panel"><input type="button" ng-class="{OT_color: true, OT_selected: c[\'background-color\'] === color}" ng-repeat="c in colors" ng-style="c" ng-click="changeColor(c)"></input><input type="button" ng-click="erase()" ng-class="{OT_erase: true, OT_selected: erasing}" value="Eraser"></input><input type="button" ng-click="capture()" class="OT_capture" value="{{captureText}}"></input><input type="button" ng-click="undo()" class="OT_capture" value="Undo"></input><input type="button" ng-click="redo()" class="OT_capture" value="Redo"></input><input type="button" ng-click="clear()" class="OT_clear" value="Clear"></input>',link:function(n,t,i){var a,r=t.context.querySelector("canvas"),c=(t.context.querySelector("select"),t.context.querySelector("input"),{dragging:!1}),s=0,u=[],d=[],l=[],p=[],g=[],h=/(iPad|iPhone|iPod)/g.test(navigator.userAgent);e.paper.setup(r),r.width=i.width||t.width(),r.height=i.height||t.height(),e.paper.view.viewSize=new e.paper.Size(r.width,r.height),e.paper.view.draw(),n.colors=[{"background-color":"black"},{"background-color":"blue"},{"background-color":"red"},{"background-color":"green"},{"background-color":"orange"},{"background-color":"purple"},{"background-color":"brown"}],n.captureText=h?"Email":"Capture",n.strokeCap="round",n.strokeJoin="round",n.lineWidth=2;var f=function(){e.paper.project.clear(),e.paper.view.update(),p=[],l=[],u=[],d=[],s=0};n.changeColor=function(o){n.color=o["background-color"],n.erasing=!1},n.changeColor(n.colors[Math.floor(Math.random()*n.colors.length)]),n.clear=function(){f(),o.session&&o.session.signal({type:"otWhiteboard_clear"})},n.erase=function(){n.erasing=!0},n.capture=function(){h?e.location.href="mailto:?subject=Whiteboard&Body=<img src='"+r.toDataURL("image/png")+"'>":e.open(r.toDataURL("image/png"))},n.undo=function(){if(u.length){var o=u.pop();v(o),W("otWhiteboard_undo",o)}};var v=function(o){d.push(o),l.some(function(n){return n.id===o?(n.visible=!1,void e.paper.view.update()):void 0})};n.redo=function(){if(d.length){var o=d.pop();b(o),W("otWhiteboard_redo",o)}};var m,b=function(o){u.push(o),l.some(function(n){return n.id===o?(n.visible=!0,void e.paper.view.update()):void 0})},k=function(o){switch(p.push(o),o.event){case"start":var t=new e.paper.Path;t.selected=!1,t.strokeColor=o.color,t.strokeWidth=n.lineWidth,t.strokeCap=n.strokeCap,t.strokeJoin=n.strokeJoin,"eraser"===o.mode&&(t.blendMode="destination-out",t.strokeWidth=50);var i=new e.paper.Point(o.fromX,o.fromY);t.moveTo(i),e.paper.view.draw(),c.pathId=t.id,l.push(t);break;case"drag":l.some(function(n){return n.id===c.pathId?(n.add(o.toX,o.toY),void e.paper.view.draw()):void 0});break;case"end":l.some(function(o){return o.id===c.pathId?(u.push(o.id),o.simplify(),void e.paper.view.draw()):void 0}),c.pathId=null}},w=function(o){o.forEach(function(o){k(o)})},y=function(e,n,t){for(var i=n.slice(),a=function(o){o&&TB.error(o)};i.length;){var r=i.splice(0,Math.min(i.length,32)),c={type:e,data:JSON.stringify(r)};t&&(c.to=t),o.session.signal(c,a)}},W=function(e,n){o.session&&(g.push(n),m||(m=setTimeout(function(){y(e,g),g=[],m=null},100)))};angular.element(document).on("keyup",function(o){o.ctrlKey&&(90===o.keyCode&&n.undo(),89===o.keyCode&&n.redo())}),angular.element(r).on("mousedown mousemove mouseup mouseout touchstart touchmove touchend touchcancel",function(e){if("mousemove"!==e.type&&"touchmove"!==e.type&&"mouseout"!==e.type||c.dragging){e.preventDefault();var i,a=angular.element(r).offset(),u=r.width/t.width(),l=r.height/t.height(),p=e.offsetX||e.originalEvent.pageX-a.left||e.originalEvent.touches[0].pageX-a.left,g=e.offsetY||e.originalEvent.pageY-a.top||e.originalEvent.touches[0].pageY-a.top,h=p*u,f=g*l,v=n.erasing?"eraser":"pen";switch(e.type){case"mousedown":case"touchstart":c.dragging=!0,c.lastX=h,c.lastY=f,i={id:o.session&&o.session.connection&&o.session.connection.connectionId,fromX:c.lastX,fromY:c.lastY,mode:v,color:n.color,event:"start"},k(i),W("otWhiteboard_update",i);break;case"mousemove":case"touchmove":p=e.offsetX||e.originalEvent.pageX-a.left||e.originalEvent.touches[0].pageX-a.left,g=e.offsetY||e.originalEvent.pageY-a.top||e.originalEvent.touches[0].pageY-a.top,h=p*u,f=g*l,c.dragging&&(i={id:o.session&&o.session.connection&&o.session.connection.connectionId,fromX:c.lastX,fromY:c.lastY,toX:h,toY:f,event:"drag"},s++,d=[],c.lastX=h,c.lastY=f,k(i),W("otWhiteboard_update",i));break;case"touchcancel":case"mouseup":case"touchend":case"mouseout":c.dragging=!1,s&&(i={id:o.session&&o.session.connection&&o.session.connection.connectionId,event:"end"},k(i),W("otWhiteboard_update",i))}}}),o.session&&o.session.on({"signal:otWhiteboard_update":function(e){e.from.connectionId!==o.session.connection.connectionId&&(w(JSON.parse(e.data)),n.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_undo":function(e){e.from.connectionId!==o.session.connection.connectionId&&(JSON.parse(e.data).forEach(function(o){v(o)}),n.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_redo":function(e){e.from.connectionId!==o.session.connection.connectionId&&(JSON.parse(e.data).forEach(function(o){b(o)}),n.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_history":function(o){a&&a!==o.from.connectionId||(a=o.from.connectionId,w(JSON.parse(o.data)),n.$emit("otWhiteboardUpdate"))},"signal:otWhiteboard_clear":function(e){e.from.connectionId!==o.session.connection.connectionId&&f()},connectionCreated:function(e){p.length>0&&e.connection.connectionId!==o.session.connection.connectionId&&(y("otWhiteboard_history",p,e.connection),d.length&&d.forEach(function(o){W("otWhiteboard_undo",o)}))}})}}}]);